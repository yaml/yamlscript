<!doctype html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-44C9DS3Q80"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-44C9DS3Q80');</script><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://yamlscript.org/posts/advent-2023/dec-20/"><link href="/assets/main.7eeaf7bb0c5b5da98e70.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Godspeed | YAMLScript</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Godspeed"><meta property="og:site_name" content="YAMLScript"><meta property="og:type" content="website"><meta property="og:url" content="https://yamlscript.org/posts/advent-2023/dec-20/"><meta name="twitter:card" content="summary_large_image"><meta name="description" content="Godspeed by Ingy döt Net | 20 Dec 2023 | 4 min read I wonder if Santa has a Hemi? Supercharged, Turbocharged? Maybe a Nitro Burning Funny..."><meta property="og:description" content="Godspeed by Ingy döt Net | 20 Dec 2023 | 4 min read I wonder if Santa has a Hemi? Supercharged, Turbocharged? Maybe a Nitro Burning Funny..."><meta name="description" content="Godspeed by Ingy döt Net | 20 Dec 2023 | 4 min read I wonder if Santa has a Hemi? Supercharged, Turbocharged? Maybe a Nitro Burning Funny..."><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/"><img src="/images/yamlscript.svg"></a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/about">About</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Godspeed</h1><div class="post__details">by <a href="/about/#ingydotnet">Ingy döt Net</a> <span>| </span><time datetime="2023-12-20">20 Dec 2023 </time><span>| </span><span>4 min read</span></div></header><main class="post__content"><p>I wonder if Santa has a Hemi? Supercharged, Turbocharged? Maybe a Nitro Burning Funny Sleigh? Dude's got to get around the world in one night. Godspeed, my festive friend!</p><h3>Welcome to Day 20 of the YAMLScript Advent Blog!</h3><p>Are YAMLScript programs compiled or interpreted? The answer is yes.</p><p>Clojure (thus YAMLScript) is a very dynamic language. Clojure code gets compiled to Java bytecode just in time. The JVM compiles the bytecode to machine code just in time. Libraries that Clojure uses are compiled ahead of time. The whole YAMLScript runtime was compiled by GraalVM native-image into a native binary so there is no JVM involved for us in the end.</p><p>It's all pretty complicated.</p><p>But I was talking about YAMLScript programs being run by the YAMLScript CLI <code>ys</code>. You can think of <code>ys</code> as an interpreter like Python, Perl, Ruby or Java. Sure, those languages <em>compile</em> to an intermediate AST/opcode-tree to be faster, but the programs are still interpreted (not binary compiled).</p><p>What if you could compile your YAMLScript program to a native binary? Like an ELF file on Linux or a Mach-O file on macOS.</p><blockquote><p>Can you guess why I like Linux better this time of year? :- )</p></blockquote><p><strong>As of today, you can natively compile YAMLScript programs!!</strong></p><p>Merry, Merry!</p><p>Let's check it out. Remember our favorite drinking song from Day 9? Here it is again:</p><pre class="language-yaml"><code class="language-yaml"><span class="token comment">#!/usr/bin/env ys-0</span><br><span class="token comment"># 99-bottles.ys</span><br><br>defn main(&amp;<span class="token punctuation">[</span>number<span class="token punctuation">]</span>)<span class="token punctuation">:</span><br>  each <span class="token punctuation">[</span>n ((number <span class="token punctuation">|</span><span class="token punctuation">|</span> 99) .. 1)<span class="token punctuation">]</span><span class="token punctuation">:</span><br>    <span class="token key atrule">say</span><span class="token punctuation">:</span><br>      <span class="token key atrule">paragraph</span><span class="token punctuation">:</span> n<br><br><span class="token key atrule">defn paragraph(num)</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"><br>  $(bottles num) of beer on the wall,<br>  $(bottles num) of beer.<br>  Take one down, pass it around.<br>  $(bottles (num - 1)) of beer on the wall.</span><br><br><span class="token key atrule">defn bottles(n)</span><span class="token punctuation">:</span><br>  <span class="token key atrule">cond</span><span class="token punctuation">:</span><br>    (n == 0) "No more bottles"<br>    (n == 1) "1 bottle"<br>    <span class="token punctuation">:</span>else    str(n " bottles")</code></pre><p>Let's see how long it takes to drink 3 bottles:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">time</span> ys <span class="token number">99</span>-bottles.ys <span class="token number">3</span><br><span class="token number">3</span> bottles of beer on the wall,<br><span class="token number">3</span> bottles of beer.<br>Take one down, pass it around.<br><span class="token number">2</span> bottles of beer on the wall.<br><br><span class="token number">2</span> bottles of beer on the wall,<br><span class="token number">2</span> bottles of beer.<br>Take one down, pass it around.<br><span class="token number">1</span> bottle of beer on the wall.<br><br><span class="token number">1</span> bottle of beer on the wall,<br><span class="token number">1</span> bottle of beer.<br>Take one down, pass it around.<br>No <span class="token function">more</span> bottles of beer on the wall.<br><br>real    0m0.075s</code></pre><p>75 milliseconds. Not bad. Let's see if we can drink a little faster, shall we?</p><pre class="language-bash"><code class="language-bash">$ ys <span class="token parameter variable">--native</span> <span class="token number">99</span>-bottles.ys<br>* Compiling YAMLScript <span class="token string">'99-bottles.ys'</span> to <span class="token string">'99-bottles'</span> executable<br>* Setting up build <span class="token function">env</span> <span class="token keyword">in</span> <span class="token string">'/tmp/tmp.wpt7O1KsWg'</span><br>* This may take a few minutes<span class="token punctuation">..</span>.<br><span class="token punctuation">[</span><span class="token number">1</span>/8<span class="token punctuation">]</span> Initializing              <span class="token punctuation">(</span><span class="token number">5</span>.0s @ <span class="token number">0</span>.08GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">2</span>/8<span class="token punctuation">]</span> Performing analysis               <span class="token punctuation">(</span><span class="token number">20</span>.7s @ <span class="token number">0</span>.35GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">3</span>/8<span class="token punctuation">]</span> Building universe         <span class="token punctuation">(</span><span class="token number">3</span>.3s @ <span class="token number">0</span>.35GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">4</span>/8<span class="token punctuation">]</span> Parsing methods           <span class="token punctuation">(</span><span class="token number">2</span>.3s @ <span class="token number">0</span>.61GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">5</span>/8<span class="token punctuation">]</span> Inlining methods          <span class="token punctuation">(</span><span class="token number">2</span>.0s @ <span class="token number">0</span>.44GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">6</span>/8<span class="token punctuation">]</span> Compiling methods         <span class="token punctuation">(</span><span class="token number">22</span>.2s @ <span class="token number">0</span>.42GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">7</span>/8<span class="token punctuation">]</span> Layouting methods         <span class="token punctuation">(</span><span class="token number">1</span>.7s @ <span class="token number">0</span>.44GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">8</span>/8<span class="token punctuation">]</span> Creating image            <span class="token punctuation">(</span><span class="token number">2</span>.3s @ <span class="token number">0</span>.51GB<span class="token punctuation">)</span><br>* Compiled YAMLScript <span class="token string">'99-bottles.ys'</span> to <span class="token string">'99-bottles'</span> executable<br>$ <span class="token function">ls</span> <span class="token parameter variable">-lh</span> <span class="token number">99</span>-bottles*<br>-rwxr-xr-x <span class="token number">1</span> ingy ingy 13M Dec <span class="token number">19</span> <span class="token number">18</span>:14 <span class="token number">99</span>-bottles*<br>-rwxr-xr-x <span class="token number">1</span> ingy ingy <span class="token number">468</span> Dec <span class="token number">19</span> <span class="token number">18</span>:10 <span class="token number">99</span>-bottles.ys*</code></pre><p>It appears that we have birthed a new beer singer! What goes better with beer than race cars?</p><details><summary><strong>Answer</strong></summary><p>Almost anything.</p></details><p></p><pre class="language-bash"><code class="language-bash">$ <span class="token function">time</span> ./99-bottles <span class="token number">3</span><br><span class="token number">3</span> bottles of beer on the wall,<br><span class="token number">3</span> bottles of beer.<br>Take one down, pass it around.<br><span class="token number">2</span> bottles of beer on the wall.<br><br><span class="token number">2</span> bottles of beer on the wall,<br><span class="token number">2</span> bottles of beer.<br>Take one down, pass it around.<br><span class="token number">1</span> bottle of beer on the wall.<br><br><span class="token number">1</span> bottle of beer on the wall,<br><span class="token number">1</span> bottle of beer.<br>Take one down, pass it around.<br>No <span class="token function">more</span> bottles of beer on the wall.<br><br>real    0m0.016s</code></pre><p>Woah! 16 milliseconds! Now we're drinking with gas! Errr... never mind.</p><p>You may have noticed that the native binary is 13 megabytes. That's because it contains the entire YAMLScript runtime. Hopefully we can get that down to a smaller size in the future.</p><p>Also did you notice that it took an annoying amount of time to compile?</p><p>Let's time native compiling a minimal program:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">time</span> ys <span class="token parameter variable">-Ce</span> <span class="token string">'say: "Hello, world!"'</span><br>* Compiling YAMLScript <span class="token string">'-e'</span> to <span class="token string">'./EVAL'</span> executable<br>* Setting up build <span class="token function">env</span> <span class="token keyword">in</span> <span class="token string">'/tmp/tmp.mahWVLE9gi'</span><br>Could not <span class="token function">find</span> main <span class="token keyword">function</span> <span class="token keyword">in</span> <span class="token string">'-e'</span><br><br>real    0m0.103s</code></pre><p>I forgot to mention. In order to <code>--native</code> compile a YAMLScript program, it must have a <code>main</code> function. That's an easy fix:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">time</span> ys <span class="token parameter variable">-Ce</span> <span class="token string">'defn main(): say("Hello, world!")'</span><br>* Compiling YAMLScript <span class="token string">'-e'</span> to <span class="token string">'./EVAL'</span> executable<br>* Setting up build <span class="token function">env</span> <span class="token keyword">in</span> <span class="token string">'/tmp/tmp.1zpmh6L1jM'</span><br>* This may take a few minutes<span class="token punctuation">..</span>.<br><span class="token punctuation">[</span><span class="token number">1</span>/8<span class="token punctuation">]</span> Initializing              <span class="token punctuation">(</span><span class="token number">4</span>.4s @ <span class="token number">0</span>.17GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">2</span>/8<span class="token punctuation">]</span> Performing analysis               <span class="token punctuation">(</span><span class="token number">17</span>.4s @ <span class="token number">0</span>.30GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">3</span>/8<span class="token punctuation">]</span> Building universe         <span class="token punctuation">(</span><span class="token number">2</span>.4s @ <span class="token number">0</span>.53GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">4</span>/8<span class="token punctuation">]</span> Parsing methods           <span class="token punctuation">(</span><span class="token number">2</span>.4s @ <span class="token number">0</span>.49GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">5</span>/8<span class="token punctuation">]</span> Inlining methods          <span class="token punctuation">(</span><span class="token number">1</span>.4s @ <span class="token number">0</span>.63GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">6</span>/8<span class="token punctuation">]</span> Compiling methods         <span class="token punctuation">(</span><span class="token number">20</span>.4s @ <span class="token number">0</span>.42GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">7</span>/8<span class="token punctuation">]</span> Layouting methods         <span class="token punctuation">(</span><span class="token number">1</span>.6s @ <span class="token number">0</span>.46GB<span class="token punctuation">)</span><br><span class="token punctuation">[</span><span class="token number">8</span>/8<span class="token punctuation">]</span> Creating image            <span class="token punctuation">(</span><span class="token number">2</span>.5s @ <span class="token number">0</span>.40GB<span class="token punctuation">)</span><br>* Compiled YAMLScript <span class="token string">'-e'</span> to <span class="token string">'./EVAL'</span> executable<br><br>real    0m59.855s</code></pre><p>Isn't that pretty cool? You can native compile a <code>-e</code> one liner!</p><p>Since the output file needs a name, <code>ys</code> uses <code>./EVAL</code> when you use <code>-e</code>. You can use the <code>-o</code> option to to name the file explicitly. Otherwise it defaults to the name of the YAMLScript file with the <code>.ys</code> extension removed.</p><p>The bad news is that it took almost a minute to compile. Currently that's the price you pay for a one-liner race car!</p><p>Let's see if this little guy has the juice:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">time</span> ./EVAL<br>Hello, world<span class="token operator">!</span><br><br>real    0m0.010s</code></pre><p><strong>Godspeed, you little global greeter!</strong></p><hr><p>YAMLScript's <code>--native</code> compiler is based on GraalVM's <code>native-image</code> tool. The same process that is used to compile the <code>ys</code> CLI binary.</p><p>I wish it were faster, but at least now we can be fast while developing our YAMLScript programs and then compile them to native binaries when we are ready to ship them.</p><p>Let's look at where YAMLScript is at now from a high level view:</p><ul><li>We have a new language that feels clean like Python</li><li>It is actually a functional language adding reliability</li><li>It's really Clojure so very complete and powerful</li><li>It's embeddable in YAML so you can enhance existing YAML files</li><li>It's a better YAML loader for plain old YAML with no magics</li><li>It's quite fast when run with the YAMLScript CLI <code>ys</code></li><li>It's even faster when compiled to a native binary</li></ul><p>I think we have a winner here!</p><p>There's still a long way to go on many fronts, but all of the above is true today. Full disclosure: I only came up the the <code>--native</code> idea 2 days ago.</p><p>Climb aboard and let's fly this baby to the moon!</p><p>Come back tomorrow for Day 21 of the YAMLScript Advent Blog!</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/blog/">#blog</a> <a href="/tags/advent-2023/">#advent-2023</a></div><nav class="post__pagination"><a href="/posts/advent-2023/dec-19/"><span>←</span> <span>Reindeer All The Way Down</span> </a><a href="/posts/advent-2023/dec-21/"><span>YAML, Python and the Holy Graal</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a href="https://github.com/yaml/yamlscript" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul><p class="footer__attribution">Powered by <a href="https://www.11ty.dev" target="_blank" rel="noopener">Eleventy</a>. Theme: <a href="https://github.com/yinkakun/eleventy-duo" target="_blank" rel="noopener noreferrer">Eleventy Duo</a>.</p></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>